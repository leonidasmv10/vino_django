{% extends 'base.html' %}
{% load static %}

{% block title %}Crear Nuevo Vino - Vinoteca Premium{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üç∑ Crear Nuevo Vino</h2>

    <form method="POST" action="{% url 'add_wine' %}" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Nombre del Vino -->
        <div class="form-group">
            <label for="name">Nombre del Vino:</label>
            <input type="text" class="form-control" id="name" name="name" placeholder="Ej: Malbec Reserva" required>
        </div>

        <!-- Descripci√≥n -->
        <div class="form-group mt-3">
            <label for="description">Descripci√≥n:</label>
            <textarea class="form-control" id="description" name="description" rows="3"
                placeholder="Escribe una breve descripci√≥n del vino..." required></textarea>
        </div>

        <!-- Precio -->
        <div class="form-group mt-3">
            <label for="price">Precio (EU):</label>
            <input type="number" class="form-control" id="price" name="price" step="0.01" min="0"
                placeholder="Ej: 25.99" required>
        </div>

        <!-- Categor√≠a (Din√°mica desde la BD) -->
        <div class="form-group mt-3">
            <label for="category">Categor√≠a:</label>
            <select class="form-control" id="category" name="category" required>
                <option value="" disabled selected>Selecciona una categor√≠a</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Atributos del Vino -->
        <div class="form-group mt-3">
            <label>Atributos:</label>
            <div class="row">
                <div class="col-md-6">
                    <label for="cuerpo">‚öîÔ∏è Cuerpo:</label>
                    <input type="number" class="form-control" id="cuerpo" name="cuerpo" min="1" max="10" value="5">
                </div>
                <div class="col-md-6">
                    <label for="aroma">üåø Aroma:</label>
                    <input type="number" class="form-control" id="aroma" name="aroma" min="1" max="10" value="5">
                </div>
                <div class="col-md-6">
                    <label for="sabor">üç∑ Sabor:</label>
                    <input type="number" class="form-control" id="sabor" name="sabor" min="1" max="10" value="5">
                </div>
                <div class="col-md-6">
                    <label for="taninos">üçá Taninos:</label>
                    <input type="number" class="form-control" id="taninos" name="taninos" min="1" max="10" value="5">
                </div>
                <div class="col-md-6">
                    <label for="acidez">üçã Acidez:</label>
                    <input type="number" class="form-control" id="acidez" name="acidez" min="1" max="10" value="5">
                </div>
                <div class="col-md-6">
                    <label for="dulzura">üç≠ Dulzura:</label>
                    <input type="number" class="form-control" id="dulzura" name="dulzura" min="1" max="10" value="5">
                </div>
                <div class="col-md-6">
                    <label for="vintage">üè∫ Vintage:</label>
                    <input type="number" class="form-control" id="vintage" name="vintage" min="1" max="10" value="5">
                </div>
            </div>
        </div>

        <!-- Imagen del Vino -->
        <div class="form-group mt-3">
            <label for="image">Imagen del Vino:</label>
            <input type="file" class="form-control-file" id="image" name="image" accept="image/*"
                onchange="previewImage()">
            <small class="text-muted">Sube una imagen del vino en formato JPG, PNG o GIF.</small>
            <div class="mt-3">
                <div class="mt-3">
                    <img id="imagePreview" src="#" alt="Vista previa de la imagen" class="img-fluid d-none"
                        style="max-width: 200px;">
                </div>
                <button type="button" class="btn btn-info mt-2" onclick="generateAIImage()">ü§ñ Generar Imagen con
                    IA</button>

            </div>
            <button type="button" class="btn btn-info mt-2" onclick="generateAIWine()">ü§ñ Generar con IA</button>

        </div>

        <!-- Bot√≥n de Enviar -->
        <button type="submit" class="btn btn-success mt-4">‚úÖ Guardar Vino</button>
    </form>
</div>

<script>
    function previewImage() {
        const file = document.getElementById("image").files[0];
        const preview = document.getElementById("imagePreview");

        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                preview.classList.remove("d-none");
            };
            reader.readAsDataURL(file);
        } else {
            preview.src = "#";
            preview.classList.add("d-none");
        }
    }

    function generateAIWine() {
        fetch("{% url 'generate_wine' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById("name").value = data.name;
                document.getElementById("description").value = data.description;
                document.getElementById("price").value = data.price;
                document.getElementById("category").value = data.category;
                document.getElementById("cuerpo").value = data.body;
                document.getElementById("aroma").value = data.aroma;
                document.getElementById("sabor").value = data.taste;
                document.getElementById("taninos").value = data.tannins;
                document.getElementById("acidez").value = data.acidity;
                document.getElementById("dulzura").value = data.sweetness;
                document.getElementById("vintage").value = data.aging;
            })
            .catch(error => console.error("Error generando el vino:", error));
    }
    function generateAIImage() {
        fetch("{% url 'generate_wine_image' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                document.getElementById("imagePreview").src = "data:image/png;base64," + data.image_base64;
                document.getElementById("imagePreview").classList.remove("d-none");
            })
            .catch(error => console.error("Error generando la imagen:", error));
    }

</script>

{% endblock %}